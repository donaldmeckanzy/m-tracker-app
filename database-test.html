<!DOCTYPE html>
<html>
<head>
    <title>M-Tracker Database Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>M-Tracker Database Connection Test</h1>
    <div id="results"></div>
    
    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';
        
        const supabaseUrl = 'https://rdfclpbgvqgdnypcuzhr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkZmNscGJndnFnZG55cGN1emhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjE4MTAsImV4cCI6MjA3NTMzNzgxMH0.f37SSefdtOR3tw6Bfl9PutymEhQLiLf2TJuzstmGh24';
        
        const supabase = createClient(supabaseUrl, supabaseKey);
        const results = document.getElementById('results');
        
        function addResult(title, content, type = 'info') {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            results.appendChild(div);
        }
        
        async function runTests() {
            addResult('üîß Configuration', `URL: ${supabaseUrl}\nKey: ${supabaseKey.substring(0, 20)}...`);
            
            try {
                // Test 1: Basic connection
                addResult('üß™ Test 1: Basic Connection', 'Testing connection...');
                const { data: healthCheck, error: healthError } = await supabase
                    .from('shared_reports')
                    .select('count')
                    .limit(1);
                
                if (healthError) {
                    addResult('‚ùå Connection Failed', `Error: ${healthError.message}\nCode: ${healthError.code}\nDetails: ${healthError.details}`, 'error');
                    return;
                }
                
                addResult('‚úÖ Connection Success', 'Database connection working!', 'success');
                
                // Test 2: Check table structure
                addResult('üß™ Test 2: Table Structure', 'Checking shared_reports table...');
                const { data: tableData, error: tableError } = await supabase
                    .from('shared_reports')
                    .select('*')
                    .limit(1);
                
                if (tableError) {
                    addResult('‚ùå Table Check Failed', `Error: ${tableError.message}`, 'error');
                    return;
                }
                
                addResult('‚úÖ Table Exists', `Table structure OK. Found ${tableData?.length || 0} records.`, 'success');
                
                // Test 3: Try to fetch a specific report (if you have one)
                const urlParams = new URLSearchParams(window.location.search);
                const reportId = urlParams.get('reportId');
                
                if (reportId) {
                    addResult('üß™ Test 3: Fetch Specific Report', `Trying to fetch report: ${reportId}`);
                    const { data: reportData, error: reportError } = await supabase
                        .from('shared_reports')
                        .select('*')
                        .eq('id', reportId)
                        .single();
                    
                    if (reportError) {
                        addResult('‚ùå Report Fetch Failed', `Error: ${reportError.message}`, 'error');
                    } else {
                        addResult('‚úÖ Report Found', JSON.stringify(reportData, null, 2), 'success');
                    }
                } else {
                    addResult('‚ÑπÔ∏è No Report ID', 'Add ?reportId=your-report-id to test a specific report');
                }
                
                // Test 4: List all reports (to see if any exist)
                addResult('üß™ Test 4: List All Reports', 'Fetching all reports...');
                const { data: allReports, error: allError } = await supabase
                    .from('shared_reports')
                    .select('id, created_at, is_active, expires_at')
                    .limit(10);
                
                if (allError) {
                    addResult('‚ùå List Reports Failed', `Error: ${allError.message}`, 'error');
                } else {
                    addResult('‚úÖ Reports List', `Found ${allReports?.length || 0} reports:\n${JSON.stringify(allReports, null, 2)}`, 'success');
                }
                
            } catch (error) {
                addResult('üí• Unexpected Error', `${error.message}\n${error.stack}`, 'error');
            }
        }
        
        runTests();
    </script>
</body>
</html>